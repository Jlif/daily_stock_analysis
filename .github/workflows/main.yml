# 在 GitHub Actions 中获取当前运行器的 IP
name: Get Runner IP
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * *'  # 每天执行一次

jobs:
  get-ip:
    runs-on: ubuntu-latest
    steps:
      - name: Get Public IP
        run: |
          # 方法1：使用多个服务获取 IP
          echo "=== 当前运行器 IP 地址 ==="
          
          # 尝试多个 IP 查询服务
          curl -s https://api.ipify.org
          echo ""
          
          curl -s https://ifconfig.me
          echo ""
          
          curl -s https://checkip.amazonaws.com
          echo ""
          
          curl -s https://ipinfo.io/ip
          echo ""
          
          # 保存 IP 到变量
          CURRENT_IP=$(curl -s https://api.ipify.org)
          echo "当前 IP: $CURRENT_IP"
          
          # 将 IP 保存到 GitHub Actions 输出
          echo "runner_ip=$CURRENT_IP" >> $GITHUB_OUTPUT
          
      - name: Send IP to DingTalk
        env:
          DINGTALK_WEBHOOK: https://oapi.dingtalk.com/robot/send?access_token=f9a1b265f03808afee9347f9e8bbf20c41d1bddbbe4616f28d7e4346040b814f
          RUNNER_IP: ${{ steps.get-ip.outputs.runner_ip }}
        run: |
          # 发送 IP 到钉钉
          curl -X POST $DINGTALK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "GitHub Actions Runner IP: '"$RUNNER_IP"'\n时间: '"$(date)"'"
              }
            }'
